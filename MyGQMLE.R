# sig in the formula is the sig^2!!!!!!!!!!!!!!pay attention.
MyGQMLE=function(h,x,dfest){
  # GGD新息的GARCH(1,1) likelihood function
  df=dfest
  likG<-function(x){
    GGL=function(para){
      n=length(x)
      sig2=numeric(n);tem1=numeric(1);tem2=numeric(1)
      w=para[1]
      alpha=para[2]
      beta=para[3]
      sig2[1]=w/(1-alpha-beta)
      for (t in 2:n){
        tem2=beta*(tem2+tem1)
        tem1=x[t-1]^2
        sig2[t]=(w/(1-beta)+alpha*(tem1+tem2)) #这按照笔记红色的通项公式改写可计算GARCH(P,Q)
      }
      if (c(w,alpha,beta) > rep(0,3) && (alpha+beta) < 1 && sig2>rep(0,n))  {
        GQMLE.e=x/(sqrt(sig2))
        #     lam=(2^(-2/df)*gamma(1/df)/gamma(3/df))^0.5
        #     f=df/(lam*2^(1+1/df)*gamma(1/df))*exp(-0.5*(abs(GQMLE.e/lam))^df)
        #     改成了p-generalized Gaussian
        f=df^(1-(1/df))/(2*gamma(1/df))*exp(-(1/df)*(abs(GQMLE.e))^df)
        sum(log(sig2)-2*log(f))
      }
      else Inf
    }
    GGL
  }
  
  #plot(c(1:500),x,type='l')
  gqmle=nlminb(c(0.01,0.01,0.01),likG(x),lower=c(0,0,0),upper=c(Inf,1,1))
  #mle.N
  list(gqmle=gqmle$par)
}
